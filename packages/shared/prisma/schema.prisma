generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "sqlite"

}

model LinkState {
  state          String @id
  telegramUserId String
  expiresAt      BigInt

  @@index([expiresAt])
}

model PlankaToken {
  telegramUserId  String @id
  plankaBaseUrl   String
  accessTokenEnc  String
  updatedAt       BigInt
}

model RastarToken {
  telegramUserId  String @id
  accessTokenEnc  String
  refreshTokenEnc String
  expiresAt       BigInt
  userId          String  // Rastar user ID
  email           String
  updatedAt       BigInt
}

model SystemConfig {
  key   String @id
  value String
}

model Admin {
  id           String @id @default(cuid())
  username     String @unique
  passwordHash String
  createdAt    BigInt
  updatedAt    BigInt
}

model SystemMessage {
  id           String @id
  language     String // 'fa' or 'en'
  messageType  String // 'welcome', 'system_prompt', 'character'
  content      String
  isActive     Boolean @default(true)
  updatedAt    BigInt

  @@unique([language, messageType])
  @@index([messageType, isActive])
}

// Character pack - a collection of system prompts, character definitions, and messages
model CharacterPack {
  id              String   @id @default(cuid())
  name            String
  description     String?
  isDefault       Boolean  @default(false)
  createdAt       BigInt
  updatedAt       BigInt
  
  // Relations
  messages        PackMessage[]
  userAssignments UserPackAssignment[]
  
  @@index([isDefault])
}

// Messages within a character pack (system prompts, welcome messages, etc.)
model PackMessage {
  id           String @id @default(cuid())
  packId       String
  language     String // 'fa' or 'en'
  messageType  String // 'welcome', 'system_prompt', 'character'
  content      String
  updatedAt    BigInt
  
  pack         CharacterPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  
  @@unique([packId, language, messageType])
  @@index([packId, messageType])
}

// User-specific character pack assignments
model UserPackAssignment {
  id              String @id @default(cuid())
  telegramUserId  String
  packId          String
  assignedAt      BigInt
  assignedBy      String? // admin username who assigned it
  
  pack            CharacterPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  
  @@unique([telegramUserId])
  @@index([packId])
}

// Telegram user information with roles
model TelegramUser {
  id              String  @id // telegram user id
  firstName       String?
  lastName        String?
  username        String?
  photoUrl        String?
  role            String  @default("user") // user, manager, admin
  lastSeenAt      BigInt?
  createdAt       BigInt
  updatedAt       BigInt
  
  @@index([role])
}

model UserPreferences {
  telegramUserId String @id
  language       String @default("fa") // Default to Persian
  updatedAt      BigInt
}

model ChatSession {
  id             String @id @default(cuid())
  telegramUserId String
  threadId       BigInt? // Forum topic/thread ID for thread-based sessions (Bot API 9.3+)
  createdAt      BigInt
  updatedAt      BigInt
  messages       Message[]

  @@index([telegramUserId])
  @@index([telegramUserId, threadId])
  @@index([updatedAt])
}

model Message {
  id                 String  @id @default(cuid())
  sessionId          String
  role               String  // 'user', 'assistant', 'system', 'tool'
  content            String
  telegramMessageId  BigInt? // Telegram message ID for reference
  replyToMessageId   BigInt? // Telegram message ID this is replying to
  threadId           BigInt? // Thread/topic ID if in a thread
  toolCallId         String? // For tool responses
  toolName           String? // For tool calls
  toolArgs           String? // JSON string of tool arguments
  createdAt          BigInt
  
  session            ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, threadId])
  @@index([createdAt])
}
