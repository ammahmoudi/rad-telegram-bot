```
ğŸ”„ Database Migration Workflow
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DEVELOPMENT (SQLite)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  1. Edit Schema
     â””â”€> packages/shared/prisma/schema.prisma
         â”œâ”€> Add model
         â”œâ”€> Add field
         â””â”€> Add index

  2. Create Migration
     â””â”€> npm run prisma:migrate
         â”œâ”€> Prompts for name
         â”œâ”€> Generates SQL
         â””â”€> Creates migration file
             â””â”€> packages/shared/prisma/migrations/
                 â””â”€> 20260106123456_your_name/
                     â””â”€> migration.sql

  3. Generate Client
     â””â”€> npm run prisma:generate
         â””â”€> Updates TypeScript types
             â””â”€> node_modules/@prisma/client/

  4. Test Locally
     â””â”€> npm run dev
         â”œâ”€> Verifies database (npm run db:verify)
         â”‚   â””â”€> Checks tables exist
         â”‚   â””â”€> Auto-applies if missing
         â””â”€> Starts applications
             â”œâ”€> Bot (SQLite)
             â”œâ”€> Portal (SQLite)
             â””â”€> Admin (SQLite)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION (PostgreSQL)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  5. Commit & Push
     â””â”€> git add packages/shared/prisma/migrations/
     â””â”€> git commit -m "feat: add new feature"
     â””â”€> git push origin main

  6. Automatic Deploy (Dokploy/Docker)
     â””â”€> Build Docker Image
         â”œâ”€> npm run build
         â””â”€> Dockerfile stages

     â””â”€> Start Container
         â””â”€> docker-entrypoint.sh
             â”‚
             â”œâ”€> ğŸ“Š npx prisma migrate deploy
             â”‚   â””â”€> Checks _prisma_migrations table
             â”‚   â””â”€> Applies only NEW migrations
             â”‚   â””â”€> Skips already-applied
             â”‚   â””â”€> âœ… Migration complete
             â”‚
             â”œâ”€> ğŸ‘¤ Create admin user (if needed)
             â”œâ”€> ğŸ­ Create default pack (if needed)
             â””â”€> âœ… Start application

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE ADAPTERS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  prisma.ts (Auto-detection)
  â”‚
  â”œâ”€> DATABASE_URL starts with "file:"
  â”‚   â””â”€> SQLite Mode
  â”‚       â”œâ”€> Convert relative â†’ absolute path
  â”‚       â”œâ”€> Create directory if needed
  â”‚       â””â”€> Use PrismaBetterSqlite3 adapter
  â”‚
  â””â”€> DATABASE_URL starts with "postgresql:"
      â””â”€> PostgreSQL Mode
          â””â”€> Use PrismaPg adapter

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MIGRATION SAFETY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  _prisma_migrations Table
  â”‚
  â”œâ”€> Tracks applied migrations
  â”‚   â”œâ”€> id: UUID
  â”‚   â”œâ”€> migration_name: "20260106123456_add_feature"
  â”‚   â”œâ”€> started_at: Timestamp
  â”‚   â”œâ”€> finished_at: Timestamp
  â”‚   â””â”€> checksum: SHA256 hash
  â”‚
  â””â”€> Migration Logic
      â”œâ”€> Check if migration_name exists
      â”œâ”€> If YES â†’ Skip (already applied)
      â””â”€> If NO â†’ Apply SQL + Record entry

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DEPLOYMENT FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Local Development
  â””â”€> npm run dev
      â””â”€> SQLite (file:./data/rastar.db)
          âœ… Instant startup
          âœ… No server needed

  Docker Compose
  â””â”€> docker compose up -d --build
      â””â”€> PostgreSQL (postgresql://postgres@postgres:5432/rastar)
          â”œâ”€> Build all services
          â”œâ”€> Start postgres container
          â”œâ”€> Wait for postgres ready
          â””â”€> Start app containers
              â””â”€> Run migrations
                  âœ… Production-like environment

  Dokploy
  â””â”€> git push origin main
      â””â”€> PostgreSQL (managed/external)
          â”œâ”€> Trigger deploy webhook
          â”œâ”€> Pull latest code
          â”œâ”€> Build Docker image
          â””â”€> Start container
              â””â”€> Run migrations
                  âœ… Zero downtime (new migrations are additive)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TROUBLESHOOTING                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Check Status
  â””â”€> npm run prisma:status
      â”œâ”€> "Database schema is up to date" âœ…
      â”œâ”€> "N pending migrations" âš ï¸
      â””â”€> "Migration failed" âŒ

  Verify Tables
  â””â”€> npm run db:verify
      â””â”€> Checks all tables exist
      â””â”€> Auto-fixes if needed

  Production Check
  â””â”€> npm run db:check
      â””â”€> Verifies PostgreSQL migrations

  View Data
  â””â”€> npm run prisma:studio
      â””â”€> Opens GUI at localhost:5555

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FILE STRUCTURE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  rastar-telegram-bot/
  â”‚
  â”œâ”€â”€ data/
  â”‚   â””â”€â”€ rastar.db                  â† SQLite database (dev)
  â”‚
  â”œâ”€â”€ packages/shared/
  â”‚   â”œâ”€â”€ prisma/
  â”‚   â”‚   â”œâ”€â”€ schema.prisma          â† Single source of truth
  â”‚   â”‚   â””â”€â”€ migrations/            â† Migration history
  â”‚   â”‚       â”œâ”€â”€ 20251228_test/
  â”‚   â”‚       â”œâ”€â”€ 20260106_add_mcp_logging/
  â”‚   â”‚       â””â”€â”€ 20260106_add_session_tracking/
  â”‚   â”‚
  â”‚   â”œâ”€â”€ src/
  â”‚   â”‚   â””â”€â”€ prisma.ts              â† Auto-adapter selection
  â”‚   â”‚
  â”‚   â””â”€â”€ scripts/
  â”‚       â””â”€â”€ reset-migrations.mjs   â† Verification script
  â”‚
  â”œâ”€â”€ scripts/
  â”‚   â”œâ”€â”€ docker-entrypoint.sh       â† Production startup
  â”‚   â””â”€â”€ check-production-migrations.mjs
  â”‚
  â””â”€â”€ docs/
      â”œâ”€â”€ MIGRATIONS_GUIDE.md        â† Full documentation
      â””â”€â”€ DATABASE_QUICK_REFERENCE.md â† This file!

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BEST PRACTICES                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âœ… Always test locally first (npm run dev)
  âœ… Use descriptive migration names
  âœ… Commit migration files to Git
  âœ… Keep migrations additive (safe for zero-downtime)
  âœ… Monitor first production deploy
  âœ… Backup before major changes

  âŒ Don't edit migration.sql files manually
  âŒ Don't delete migration files
  âŒ Don't skip migrations
  âŒ Don't modify _prisma_migrations table

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      QUICK COMMANDS                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Development:
    npm run dev              # Start with verification
    npm run prisma:migrate   # Create new migration
    npm run prisma:status    # Check status
    npm run db:verify        # Verify database

  Production:
    git push origin main     # Auto-deploys + migrates
    npm run db:check         # Check PostgreSQL
    docker compose logs -f   # Watch deployment

  Emergency:
    docker exec -it rastar-telegram-bot sh
    cd packages/shared
    npx prisma migrate deploy

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
