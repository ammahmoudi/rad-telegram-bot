# Docker Compose with Standalone MCP Servers (Optional Configuration)
# Use this if you want to run MCPs as separate microservices


services:
  # === Main Application Services ===
  
  telegram-bot:
    build:
      context: .
      dockerfile: ./apps/telegram-bot/Dockerfile
    container_name: rastar-telegram-bot
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/rastar.db
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - DEFAULT_AI_MODEL=${DEFAULT_AI_MODEL:-anthropic/claude-3.5-sonnet}
      - RASTAR_API_URL=${RASTAR_API_URL}
      - RASTAR_USERNAME=${RASTAR_USERNAME}
      - RASTAR_PASSWORD=${RASTAR_PASSWORD}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - LINK_PORTAL_URL=${LINK_PORTAL_URL:-http://link-portal:3002}
      # Optional: Use standalone MCP servers
      # - MCP_PLANKA_HOST=mcp-planka
      # - MCP_RASTAR_HOST=mcp-rastar
    volumes:
      - app-data:/app/data
      - ./logs/telegram-bot:/app/logs
    networks:
      - rastar-network
    depends_on:
      link-portal:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  link-portal:
    build:
      context: .
      dockerfile: ./apps/link-portal/Dockerfile
    container_name: rastar-link-portal
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=file:/app/data/rastar.db
      - RASTAR_API_URL=${RASTAR_API_URL}
      - RASTAR_USERNAME=${RASTAR_USERNAME}
      - RASTAR_PASSWORD=${RASTAR_PASSWORD}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    ports:
      - "3002:3002"
    volumes:
      - app-data:/app/data
      - ./logs/link-portal:/app/logs
    networks:
      - rastar-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  admin-panel:
    build:
      context: .
      dockerfile: ./apps/admin-panel/Dockerfile
    container_name: rastar-admin-panel
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=file:/app/data/rastar.db
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NEXT_TELEMETRY_DISABLED=1
    ports:
      - "3000:3000"
    volumes:
      - app-data:/app/data
      - ./logs/admin-panel:/app/logs
    networks:
      - rastar-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # === Optional: Standalone MCP Servers ===
  # Uncomment these if you want to run MCPs as separate services
  # Note: MCP servers use stdio transport, so they need a different
  # communication mechanism (e.g., message queue or custom RPC)
  
  # mcp-planka:
  #   build:
  #     context: .
  #     dockerfile: ./packages/mcp-planka/Dockerfile
  #   container_name: rastar-mcp-planka
  #   restart: unless-stopped
  #   environment:
  #     - NODE_ENV=production
  #     - DATABASE_URL=file:/app/data/rastar.db
  #     - PLANKA_SERVER_URL=${PLANKA_SERVER_URL}
  #   volumes:
  #     - app-data:/app/data
  #     - ./logs/mcp-planka:/app/logs
  #   networks:
  #     - rastar-network
  #   stdin_open: true
  #   tty: true
  
  # mcp-rastar:
  #   build:
  #     context: .
  #     dockerfile: ./packages/mcp-rastar/Dockerfile
  #   container_name: rastar-mcp-rastar
  #   restart: unless-stopped
  #   environment:
  #     - NODE_ENV=production
  #     - DATABASE_URL=file:/app/data/rastar.db
  #     - RASTAR_API_URL=${RASTAR_API_URL}
  #     - RASTAR_USERNAME=${RASTAR_USERNAME}
  #     - RASTAR_PASSWORD=${RASTAR_PASSWORD}
  #   volumes:
  #     - app-data:/app/data
  #     - ./logs/mcp-rastar:/app/logs
  #   networks:
  #     - rastar-network
  #   stdin_open: true
  #   tty: true

networks:
  rastar-network:
    driver: bridge
    name: rastar-network

volumes:
  app-data:
    driver: local
    name: rastar-data
