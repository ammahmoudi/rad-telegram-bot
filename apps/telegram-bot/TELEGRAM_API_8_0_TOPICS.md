# Telegram Bot API 8.0+ Integration: Topics in Private Chats

This document describes the implementation of new Telegram Bot API features for streaming messages and topic support in private chats.

## Overview of New Features

The Telegram Bot API has been updated with support for topics (forum-style conversations) in private chats, along with message streaming capabilities. This implementation integrates these features into the Rastar Telegram Bot.

## 1. New API Fields and Methods

### User Class Extensions
- **`has_topics_enabled`**: Boolean field indicating whether forum topic mode is enabled for the bot in private chats
  - Used to determine if the bot can manage topics for this user
  - Available via `isUserTopicsEnabled(ctx)` helper function

### Message Class Extensions
- **`message_thread_id`**: The unique identifier of a forum topic (or a forum supergroup) the message belongs to
- **`is_topic_message`**: Boolean indicating if the message was sent to a forum topic
  - Available via `isTopicMessage(ctx)` helper function

### Forum Topic Classes
- **`is_name_implicit`**: Boolean in `ForumTopic` and `ForumTopicCreated` classes
  - Indicates if the topic name was automatically generated by forum creation options

### New Methods with Topic Support
The following methods now support `message_thread_id` parameter for sending messages to specific topics in private chats:
- `sendMessage`
- `sendMessageDraft` (NEW - for streaming)
- `sendPhoto`
- `sendVideo`
- `sendAnimation`
- `sendAudio`
- `sendDocument`
- `sendPaidMedia`
- `sendSticker`
- `sendVideoNote`
- `sendVoice`
- `sendLocation`
- `sendVenue`
- `sendContact`
- `sendPoll`
- `sendDice`
- `sendInvoice`
- `sendGame`
- `sendMediaGroup`
- `copyMessage`
- `copyMessages`
- `forwardMessage`
- `forwardMessages`
- `sendChatAction` (now supports topics in private chats)

### New Streaming Method
- **`sendMessageDraft`**: Allows partial messages to be streamed to a user while being generated
  - Replaces the traditional approach of sending a message and then editing it
  - Provides better UX during long-running AI generation tasks
  - Status: Awaiting official Grammy/Telegram SDK support

## 2. Implementation Architecture

### Type Definitions
File: `apps/telegram-bot/src/types/telegram-api-extensions.ts`

Contains TypeScript interfaces for:
- `UserWithTopics`: Extended User type
- `MessageWithTopics`: Extended Message type
- `ForumTopicWithImplicitName`: Forum topic with implicit name support
- `SendMessageWithTopicParams`: Parameters for topic-aware message sending
- `SendChatActionWithTopicParams`: Parameters for chat actions with topic support
- `SendMessageDraftParams`: Parameters for draft message streaming
- `UserTopicContext`: Context tracking for user topic settings
- `TopicAwareSendConfig`: Configuration for topic-aware sending

### Draft Streaming Service
File: `apps/telegram-bot/src/services/draft-streaming.ts`

Provides helper functions:
- **`streamMessageDraft(ctx, initialText, messageThreadId, updateCallback, options)`**: Stream a message draft with periodic updates
  - Handles message truncation
  - Supports HTML/Markdown parsing modes
  - Respects Telegram's rate limiting

- **`updateMessageDraft(ctx, chatId, text, messageThreadId, parseMode)`**: Update an existing draft message

- **`isUserTopicsEnabled(ctx): boolean`**: Check if user has topics enabled
  - Reads `has_topics_enabled` from the User object

- **`getMessageThreadId(ctx): number | undefined`**: Extract message thread ID from context
  - Returns the topic ID if message is in a topic

- **`isTopicMessage(ctx): boolean`**: Check if current message is a topic message

### Message Streaming Integration
File: `apps/telegram-bot/src/handlers/message-streaming.ts`

Updates:
- Extract `message_thread_id` from incoming messages
- Pass `message_thread_id` to `editMessageText` calls when available
- Log topic information for debugging
- Supports streaming AI responses to the correct topic

### AI Message Handler
File: `apps/telegram-bot/src/handlers/ai-message.ts`

Updates:
- Import topic helper functions
- Detect user's topic status and message thread ID
- Include `message_thread_id` in initial message send options
- Log topic information when processing messages

### AI Button Callback Handler
File: `apps/telegram-bot/src/handlers/ai-button-callback.ts`

Updates:
- Detect topic information from callback context
- Include `message_thread_id` in message echoing
- Pass topic information to fake message context for AI handler
- Support `sendChatAction` with topic ID

### Callback Handlers
File: `apps/telegram-bot/src/handlers/callback-handlers.ts`

Updates:
- Include `message_thread_id` in fake message context creation
- Maintain topic context when simulating user messages

## 3. Usage Examples

### Checking if User has Topics Enabled
```typescript
import { isUserTopicsEnabled } from '../services/draft-streaming.js';

if (isUserTopicsEnabled(ctx)) {
  console.log('User has topics enabled in private chat');
}
```

### Getting Current Message Thread ID
```typescript
import { getMessageThreadId } from '../services/draft-streaming.js';

const threadId = getMessageThreadId(ctx);
if (threadId) {
  console.log(`Message is in topic with ID: ${threadId}`);
}
```

### Sending a Message to a Specific Topic
```typescript
const messageThreadId = getMessageThreadId(ctx);

await ctx.reply('Your response', {
  parse_mode: 'HTML',
  message_thread_id: messageThreadId, // Optional, only if in a topic
});
```

### Sending Chat Action to a Topic
```typescript
const messageThreadId = getMessageThreadId(ctx);

await ctx.api.sendChatAction(ctx.chat?.id, 'typing', {
  message_thread_id: messageThreadId,
});
```

## 4. Future Enhancements

### sendMessageDraft Support
When Grammy and Telegram Bot API SDK officially support `sendMessageDraft`, the streaming service will be updated to:
- Use native `sendMessageDraft` instead of `editMessageText`
- Provide smoother streaming experience
- Reduce API calls

### Topic Management
Future updates could include:
- Forum topic creation in private chats (`editForumTopic`)
- Topic deletion (`deleteForumTopic`)
- Unpinning all messages in a topic (`unpinAllForumTopicMessages`)

### Advanced Features
- Automatic topic detection and adaptation
- Topic-aware conversation history tracking
- Per-topic user preferences and settings

## 5. Backward Compatibility

All changes are backward compatible:
- Topic-related parameters are optional
- Existing code without topic support continues to work
- Non-topic users are unaffected
- All changes are additive with no breaking modifications

## 6. Debugging and Logging

The implementation includes comprehensive logging:

```typescript
console.log('[message-streaming] User topic info:', {
  hasTopicsEnabled: userHasTopics,
  messageThreadId,
  isTopicMessage: isTopicMsg,
});
```

Look for logs tagged with `[message-streaming]`, `[ai-message]`, and `[telegram-bot]` to track topic-related operations.

## 7. Testing

To test topic support:

1. Enable forum topic mode in your private chat with the bot
2. Create multiple topics
3. Send messages to different topics
4. Verify the bot responds in the correct topic
5. Check logs for proper topic ID detection

Example test scenario:
- User has `has_topics_enabled = true`
- Create topic "AI Questions"
- Send message to that topic
- Bot should respond in the same topic (message_thread_id preserved)
- Check logs: `messageThreadId` should match the topic ID

## 8. API Reference

### Helper Functions

#### `isUserTopicsEnabled(ctx: Context): boolean`
**Returns:** Whether the user has topics enabled in private chats

#### `getMessageThreadId(ctx: Context): number | undefined`
**Returns:** The message thread ID if the message is in a topic, undefined otherwise

#### `isTopicMessage(ctx: Context): boolean`
**Returns:** Whether the current message was sent to a forum topic

#### `streamMessageDraft(ctx, initialText, messageThreadId, updateCallback, options)`
**Parameters:**
- `ctx`: Grammy Context
- `initialText`: Initial message text
- `messageThreadId`: Optional topic/thread ID
- `updateCallback`: Function that provides updated text
- `options`: Configuration with `updateInterval`, `parseMode`, `maxLength`

**Returns:** Promise<void>

#### `updateMessageDraft(ctx, chatId, text, messageThreadId, parseMode)`
**Parameters:**
- `ctx`: Grammy Context
- `chatId`: Target chat ID
- `text`: Message text
- `messageThreadId`: Optional topic/thread ID
- `parseMode`: Text format (HTML, Markdown, MarkdownV2)

**Returns:** Promise<void>

## 9. References

- [Telegram Bot API 8.0 Release Notes](https://core.telegram.org/bots/api-changelog#december-18-2024)
- [Telegram Bot API Documentation](https://core.telegram.org/bots/api)
- [Grammy Documentation](https://grammy.dev)
- Local Implementation: [Type Definitions](./types/telegram-api-extensions.ts)
- Local Implementation: [Streaming Service](./services/draft-streaming.ts)
